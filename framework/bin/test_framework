#!/usr/bin/env php
<?php
/**
 * Horde Test Runner
 *
 * @category Horde
 * @package  tools
 * @subpackage UnitTests
 * @author   Chuck Hagenbuch <chuck@horde.org>
 * @license  http://www.horde.org/licenses/bsd BSD
 */

/* Stand-in functions if gettext is not available. */
if (!function_exists('_')) {
    function _($string)
    {
        return $string;
    }
}
if (!function_exists('dgettext')) {
    function dgettext($domain, $string)
    {
        return $string;
    }
}
if (!function_exists('ngettext')) {
    function ngettext($msgid1, $msgid2, $n)
    {
        return $n > 1 ? $msgid2 : $msgid1;
    }
}
if (!function_exists('bindtextdomain')) {
    function bindtextdomain()
    {}
}
if (!function_exists('textdomain')) {
    function textdomain()
    {}
}

require_once 'PHPUnit/Util/Filter.php';
require_once 'PHPUnit/TextUI/Command.php';
set_include_path(dirname(dirname(__DIR__)) . '/lib:' . get_include_path());
require_once 'Horde/Test/AllTests.php';

$_SERVER['argv'][] = 'horde_test_runner';
$_SERVER['argv'][] = __FILE__;
define('PHPUnit_MAIN_METHOD', 'PHPUnit_TextUI_Command::main');
PHPUnit_TextUI_Command::main();

/**
 * @category Horde
 * @package  tools
 * @subpackage UnitTests
 * @author   Chuck Hagenbuch <chuck@horde.org>
 * @license  http://www.horde.org/licenses/lgpl21
 */
class horde_test_runner
{
    public static function suite()
    {
        $suite = new PHPUnit_Framework_TestSuite('Horde Test Runner');

        $basedir = dirname(__DIR__);
        $baseregexp = preg_quote($basedir . DIRECTORY_SEPARATOR, '/');

        // Find all AllTests.php files.
        foreach (new RecursiveIteratorIterator(new RecursiveDirectoryIterator($basedir)) as $file) {
            if (!$file->isFile() ||
                $file->getFilename() != 'AllTests.php' ||
                $file->getPathname() == __FILE__ ||
                $file->getPathname() == $basedir . '/Test/lib/Horde/Test/AllTests.php') {
                continue;
            }
            $pathname = $file->getPathname();

            // Include the test suite.
            $suite->addTestSuite(Horde_Test_AllTests::init($pathname)->suite());
        }

        return $suite;
    }
}
